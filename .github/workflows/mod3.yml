name: Build Adjustable Fast Place (1.20.1 - Right Shift to Adjust Speed)

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/adjustplace/mixin
        mkdir -p src/main/resources
    
    - name: Write AdjustPlaceMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/adjustplace/AdjustPlaceMod.java
        package com.adjustplace;
        
        import net.fabricmc.api.ClientModInitializer;
        
        public class AdjustPlaceMod implements ClientModInitializer {
            public static final String MOD_ID = "adjustplace";
            public static boolean isEnabled = false;
            public static int targetCPS = 30; // Default: 30 CPS
            
            @Override
            public void onInitializeClient() {
                // Silent initialization
            }
        }
        EOF
    
    - name: Write MinecraftClientMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/adjustplace/mixin/MinecraftClientMixin.java
        package com.adjustplace.mixin;
        
        import com.adjustplace.AdjustPlaceMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.text.Text;
        import net.minecraft.util.Hand;
        import net.minecraft.util.hit.BlockHitResult;
        import net.minecraft.util.hit.HitResult;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        import java.util.Random;
        
        @Mixin(MinecraftClient.class)
        public class MinecraftClientMixin {
            @Shadow
            public ClientPlayerEntity player;
            
            @Shadow
            public HitResult crosshairTarget;
            
            @Shadow
            private int itemUseCooldown;
            
            private boolean wasRightAltPressed = false;
            private boolean wasRightShiftPressed = false;
            private int placeDelay = 0;
            private final Random random = new Random();
            private int messageTimer = 0;
            
            /**
             * ADJUSTABLE FAST BLOCK PLACEMENT
             * 
             * Controls:
             * - RIGHT ALT: Toggle on/off
             * - RIGHT SHIFT: Cycle through speeds (10, 20, 30, 40, 50 CPS)
             * 
             * Features:
             * - Adjustable speed while playing!
             * - Each block placement = proper hand swing
             * - Only swings when block actually places
             */
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                
                // Decrease message timer
                if (messageTimer > 0) {
                    messageTimer--;
                }
                
                // Toggle with RIGHT ALT
                boolean isRightAltPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_RIGHT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isRightAltPressed && !wasRightAltPressed) {
                    AdjustPlaceMod.isEnabled = !AdjustPlaceMod.isEnabled;
                    if (messageTimer == 0) {
                        String status = AdjustPlaceMod.isEnabled ? "§a§lON" : "§c§lOFF";
                        this.player.sendMessage(
                            Text.literal("§6[Fast Place] " + status + " §7(" + AdjustPlaceMod.targetCPS + " CPS)"), 
                            true
                        );
                        messageTimer = 20; // 1 second
                    }
                }
                wasRightAltPressed = isRightAltPressed;
                
                // Adjust speed with RIGHT SHIFT
                boolean isRightShiftPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_RIGHT_SHIFT
                ) == GLFW.GLFW_PRESS;
                
                if (isRightShiftPressed && !wasRightShiftPressed) {
                    // Cycle: 10 → 20 → 30 → 40 → 50 → 10...
                    switch (AdjustPlaceMod.targetCPS) {
                        case 10 -> AdjustPlaceMod.targetCPS = 20;
                        case 20 -> AdjustPlaceMod.targetCPS = 30;
                        case 30 -> AdjustPlaceMod.targetCPS = 40;
                        case 40 -> AdjustPlaceMod.targetCPS = 50;
                        case 50 -> AdjustPlaceMod.targetCPS = 10;
                        default -> AdjustPlaceMod.targetCPS = 30;
                    }
                    
                    if (messageTimer == 0) {
                        this.player.sendMessage(
                            Text.literal("§6[Fast Place] Speed: §b§l" + AdjustPlaceMod.targetCPS + " CPS"), 
                            true
                        );
                        messageTimer = 20;
                    }
                }
                wasRightShiftPressed = isRightShiftPressed;
                
                // Decrease delay counter
                if (placeDelay > 0) {
                    placeDelay--;
                }
                
                // If enabled
                if (AdjustPlaceMod.isEnabled) {
                    // Remove vanilla 4-tick delay
                    if (this.itemUseCooldown > 0) {
                        this.itemUseCooldown = 0;
                    }
                    
                    // Check if HOLDING Right Click
                    boolean isRightClickHeld = GLFW.glfwGetMouseButton(
                        client.getWindow().getHandle(),
                        GLFW.GLFW_MOUSE_BUTTON_RIGHT
                    ) == GLFW.GLFW_PRESS;
                    
                    if (isRightClickHeld && placeDelay == 0) {
                        // Place one block
                        tryPlaceBlock(client);
                        
                        // Calculate delay based on target CPS
                        // Formula: delay (in ticks) = 20 / targetCPS
                        // Example: 30 CPS → 20/30 = 0.66 ticks average
                        float ticksPerPlacement = 20.0f / AdjustPlaceMod.targetCPS;
                        
                        // Add randomness for natural feel
                        // ±20% variation
                        float variation = (random.nextFloat() * 0.4f) - 0.2f; // -0.2 to +0.2
                        ticksPerPlacement = ticksPerPlacement * (1.0f + variation);
                        
                        // Convert to integer delay
                        placeDelay = Math.max(0, Math.round(ticksPerPlacement));
                    }
                }
            }
            
            /**
             * Try to place a block (with proper hand animation ONLY if block placed)
             */
            private void tryPlaceBlock(MinecraftClient client) {
                if (this.player == null) return;
                if (this.crosshairTarget == null) return;
                if (this.crosshairTarget.getType() != HitResult.Type.BLOCK) return;
                if (this.player.getMainHandStack().isEmpty()) return;
                
                try {
                    BlockHitResult blockHit = (BlockHitResult) this.crosshairTarget;
                    
                    // Try to place the block
                    var result = client.interactionManager.interactBlock(
                        this.player,
                        Hand.MAIN_HAND,
                        blockHit
                    );
                    
                    // ONLY swing hand if block was actually placed!
                    if (result.isAccepted()) {
                        this.player.swingHand(Hand.MAIN_HAND);
                    }
                    
                } catch (Exception e) {
                    // Silent fail
                }
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "adjustplace",
          "version": "1.0.0",
          "name": "Adjustable Fast Place",
          "description": "RIGHT ALT = Toggle, RIGHT SHIFT = Adjust Speed (10-50 CPS). Hold Right Click to place blocks!",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.adjustplace.AdjustPlaceMod"]
          },
          "mixins": ["adjustplace.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.19",
            "minecraft": "1.20.1"
          }
        }
        EOF
    
    - name: Write adjustplace.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/adjustplace.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.adjustplace.mixin",
          "compatibilityLevel": "JAVA_17",
          "client": ["MinecraftClientMixin"],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '1.2-SNAPSHOT'
            id 'maven-publish'
        }
        
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        
        archivesBaseName = "adjustable-fast-place"
        version = "1.0.0"
        group = "com.adjustplace"
        
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "curse.maven:fabric-api-306612:4902738"
        }
        
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
            it.options.release = 17
        }
        
        java {
            withSourcesJar()
        }
        
        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'adjustable-fast-place'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 8.1
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo ""
        echo "=== Config files ==="
        cat build.gradle
        echo ""
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: adjustable-fast-place-v1.0.0-10-50cps-mc1.20.1
        path: build/libs/*.jar
