name: Build Right Click CPS Mod (1.20.1 - Auto Place Blocks)

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/rightclickcps/mixin
        mkdir -p src/main/resources
    
    - name: Write RightClickCPSMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/rightclickcps/RightClickCPSMod.java
        package com.rightclickcps;
        
        import net.fabricmc.api.ClientModInitializer;
        
        public class RightClickCPSMod implements ClientModInitializer {
            public static final String MOD_ID = "rightclickcps";
            public static boolean isEnabled = false;
            
            @Override
            public void onInitializeClient() {
                System.out.println("[Right Click CPS] Mod loaded!");
                System.out.println("[Right Click CPS] Press RIGHT ALT to toggle!");
                System.out.println("[Right Click CPS] âš¡ 20 CPS - ABSOLUTE MAXIMUM SPEED! âš¡");
            }
        }
        EOF
    
    - name: Write MinecraftClientMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/rightclickcps/mixin/MinecraftClientMixin.java
        package com.rightclickcps.mixin;
        
        import com.rightclickcps.RightClickCPSMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.item.BlockItem;
        import net.minecraft.item.ItemStack;
        import net.minecraft.text.Text;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.gen.Invoker;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        @Mixin(MinecraftClient.class)
        public abstract class MinecraftClientMixin {
            @Shadow
            public ClientPlayerEntity player;
            
            @Invoker("doItemUse")
            protected abstract void invokeDoItemUse();
            
            private boolean wasAltPressed = false;
            
            /**
             * Right Click CPS Mod - Minecraft 1.20.1
             * 
             * Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
             * âœ… Auto Right-Click: 20 CPS - ABSOLUTE MAXIMUM!
             * âœ… Toggle Ø¨Ù€ RIGHT ALT  
             * âœ… ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ù„Ù…Ø§ ØªÙƒÙˆÙ† Ù…Ø§Ø³Ùƒ Ø¨Ù„ÙˆÙƒØ©
             * âœ… ÙŠØ´ØªØºÙ„ Ù„Ù…Ø§ ØªØ¶ØºØ· Right Click Ù…Ø·ÙˆÙ„
             * 
             * Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:
             * - Click ÙÙŠ ÙƒÙ„ tick = 20 clicks ÙÙŠ 20 ticks = 20 CPS! âœ…
             * - Ø¯Ù‡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø·Ù„Ù‚ ÙÙŠ Minecraft!
             * - Ù…ÙÙŠØ´ Ø£Ø³Ø±Ø¹ Ù…Ù† ÙƒØ¯Ù‡! ğŸ”¥
             * 
             * âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ Ù‚Ø¯ ÙŠØ¹ØªØ¨Ø± ØºØ´ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª!
             * Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø¹Ù„Ù‰ Ù…Ø³Ø¤ÙˆÙ„ÙŠØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©!
             */
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                
                // Toggle Ø¨Ù€ RIGHT ALT (GLFW_KEY_RIGHT_ALT)
                boolean isAltPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_RIGHT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isAltPressed && !wasAltPressed) {
                    RightClickCPSMod.isEnabled = !RightClickCPSMod.isEnabled;
                    String status = RightClickCPSMod.isEnabled ? 
                        "Â§cÂ§lâš¡ MAXIMUM SPEED (20 CPS) âš¡" : "Â§cÂ§lOFF";
                    this.player.sendMessage(
                        Text.literal("Â§6Â§l[Right Click CPS] " + status), 
                        true
                    );
                }
                
                wasAltPressed = isAltPressed;
                
                // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¯ Ù…Ø´ Ø´ØºØ§Ù„ØŒ Ù…ØªØ¹Ù…Ù„Ø´ Ø­Ø§Ø¬Ø©
                if (!RightClickCPSMod.isEnabled) {
                    return;
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ Auto Right Click
                applyAutoRightClick();
            }
            
            /**
             * ØªØ·Ø¨ÙŠÙ‚ Auto Right Click Ù„Ù…Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø§Ø³Ùƒ Ø¨Ù„ÙˆÙƒØ© ÙˆØ¶Ø§ØºØ· Right Click
             * 
             * Ø§Ù„Ø¨Ø§ØªØ±Ù† Ù„Ù€ 20 CPS - ABSOLUTE MAXIMUM:
             * - Click ÙÙŠ ÙƒÙ„ tick!
             * - 20 ticks = 20 clicks = 20 CPS
             * - Ù…ÙÙŠØ´ skip Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚!
             * 
             * Ø§Ù„Ø­Ø³Ø¨Ø©:
             * - 20 clicks Ã· 20 ticks = 1.0 click per tick
             * - 1.0 Ã— 20 ticks per second = 20 CPS! ğŸ¯
             * 
             * Ø¯Ù‡ 100% Ù…Ù† Ø§Ù„Ù€ maximum speed!
             * Ø£Ø³Ø±Ø¹ Ø³Ø±Ø¹Ø© Ù…Ù…ÙƒÙ†Ø© ÙÙŠ Minecraft! ğŸ”¥
             */
            private void applyAutoRightClick() {
                if (this.player == null) return;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø§Ø³Ùƒ Ø¨Ù„ÙˆÙƒØ© ÙÙŠ Ø¥ÙŠØ¯Ù‡
                ItemStack mainHandStack = this.player.getMainHandStack();
                if (mainHandStack.isEmpty() || !(mainHandStack.getItem() instanceof BlockItem)) {
                    return;
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Right Click Ù…Ø¶ØºÙˆØ·
                boolean isRightClickPressed = GLFW.glfwGetMouseButton(
                    client.getWindow().getHandle(),
                    GLFW.GLFW_MOUSE_BUTTON_RIGHT
                ) == GLFW.GLFW_PRESS;
                
                if (!isRightClickPressed) {
                    return;
                }
                
                // Ø§Ø¹Ù…Ù„ click ÙÙŠ ÙƒÙ„ tick - Ù…ÙÙŠØ´ ØªÙˆÙ‚Ù!
                // Ø¯Ù‡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø·Ù„Ù‚ - 20 CPS!
                invokeDoItemUse();
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "rightclickcps",
          "version": "1.0.0",
          "name": "Right Click CPS",
          "description": "Press RIGHT ALT to toggle! âš¡ 20 CPS - ABSOLUTE MAXIMUM SPEED! âš¡",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.rightclickcps.RightClickCPSMod"]
          },
          "mixins": ["rightclickcps.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.19",
            "minecraft": "1.20.1"
          }
        }
        EOF
    
    - name: Write rightclickcps.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/rightclickcps.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.rightclickcps.mixin",
          "compatibilityLevel": "JAVA_17",
          "client": [
            "MinecraftClientMixin"
          ],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '1.2-SNAPSHOT'
            id 'maven-publish'
        }
        
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        
        archivesBaseName = "right-click-cps"
        version = "1.0.0"
        group = "com.rightclickcps"
        
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "curse.maven:fabric-api-306612:4902738"
        }
        
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
            it.options.release = 17
        }
        
        java {
            withSourcesJar()
        }
        
        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'right-click-cps'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 8.1
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo ""
        echo "=== Config files ==="
        cat build.gradle
        echo ""
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: right-click-cps-v1.0.0-mc1.20.1
        path: build/libs/*.jar
