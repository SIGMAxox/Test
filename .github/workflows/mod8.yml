name: Build Quick Transfer Mod (1.20.1)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    - uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    - name: Clean
      run: rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew*
    - name: Create dirs
      run: mkdir -p src/main/java/com/quicktransfer/mixin src/main/resources

    - name: Write QuickTransferMod.java
      run: |
        cat > src/main/java/com/quicktransfer/QuickTransferMod.java << 'EOF'
        package com.quicktransfer;
        import net.fabricmc.api.ClientModInitializer;
        public class QuickTransferMod implements ClientModInitializer {
            public static boolean isEnabled = false;
            public static int transferSpeed = 1; // items per tick
            @Override
            public void onInitializeClient() {
                System.out.println("[Quick Transfer] Loaded!");
                System.out.println("Press 7: Take all items");
                System.out.println("Press 8: Return all items");
                System.out.println("Press 9: Toggle auto loop");
            }
        }
        EOF

    - name: Write MinecraftClientMixin.java
      run: |
        cat > src/main/java/com/quicktransfer/mixin/MinecraftClientMixin.java << 'EOF'
        package com.quicktransfer.mixin;
        import com.quicktransfer.QuickTransferMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.gui.screen.Screen;
        import net.minecraft.client.gui.screen.ingame.HandledScreen;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.item.ItemStack;
        import net.minecraft.screen.ScreenHandler;
        import net.minecraft.screen.slot.Slot;
        import net.minecraft.screen.slot.SlotActionType;
        import net.minecraft.text.Text;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        @Mixin(MinecraftClient.class)
        public class MinecraftClientMixin {
            @Shadow public ClientPlayerEntity player;
            @Shadow public Screen currentScreen;
            
            private boolean wasTakeKeyPressed = false;
            private boolean wasReturnKeyPressed = false;
            private boolean wasToggleKeyPressed = false;
            private boolean isLooping = false;
            private int loopState = 0; // 0 = take, 1 = return
            private int tickCounter = 0;
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                if (!(this.currentScreen instanceof HandledScreen)) {
                    isLooping = false;
                    return;
                }
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                HandledScreen<?> screen = (HandledScreen<?>) this.currentScreen;
                ScreenHandler handler = screen.getScreenHandler();
                
                // Key 7: Take all
                boolean isTakeKeyPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(),
                    GLFW.GLFW_KEY_7
                ) == GLFW.GLFW_PRESS;
                
                // Key 8: Return all
                boolean isReturnKeyPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(),
                    GLFW.GLFW_KEY_8
                ) == GLFW.GLFW_PRESS;
                
                // Key 9: Toggle loop
                boolean isToggleKeyPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(),
                    GLFW.GLFW_KEY_9
                ) == GLFW.GLFW_PRESS;
                
                // Toggle loop mode
                if (isToggleKeyPressed && !wasToggleKeyPressed) {
                    isLooping = !isLooping;
                    loopState = 0;
                    tickCounter = 0;
                    String status = isLooping ? "§a§lON" : "§c§lOFF";
                    this.player.sendMessage(
                        Text.literal("§6§l[Quick Transfer] §7Auto Loop: " + status), 
                        true
                    );
                }
                
                // Manual take
                if (isTakeKeyPressed && !wasTakeKeyPressed && !isLooping) {
                    takeAllItems(handler, client);
                    this.player.sendMessage(
                        Text.literal("§a§l[Quick Transfer] §7Taking all items..."), 
                        true
                    );
                }
                
                // Manual return
                if (isReturnKeyPressed && !wasReturnKeyPressed && !isLooping) {
                    returnAllItems(handler, client);
                    this.player.sendMessage(
                        Text.literal("§e§l[Quick Transfer] §7Returning all items..."), 
                        true
                    );
                }
                
                // Auto loop mode
                if (isLooping) {
                    tickCounter++;
                    if (tickCounter >= 10) { // Wait 10 ticks between operations
                        tickCounter = 0;
                        if (loopState == 0) {
                            takeAllItems(handler, client);
                            loopState = 1;
                            this.player.sendMessage(
                                Text.literal("§a§l[Loop] §7→ Taking..."), 
                                true
                            );
                        } else {
                            returnAllItems(handler, client);
                            loopState = 0;
                            this.player.sendMessage(
                                Text.literal("§e§l[Loop] §7← Returning..."), 
                                true
                            );
                        }
                    }
                }
                
                wasTakeKeyPressed = isTakeKeyPressed;
                wasReturnKeyPressed = isReturnKeyPressed;
                wasToggleKeyPressed = isToggleKeyPressed;
            }
            
            private void takeAllItems(ScreenHandler handler, MinecraftClient client) {
                // Take all items from container (top slots)
                int containerSlots = handler.slots.size() - 36; // Exclude player inventory
                
                for (int i = 0; i < containerSlots; i++) {
                    Slot slot = handler.slots.get(i);
                    if (slot.hasStack()) {
                        // Quick move (shift+click) to player inventory
                        client.interactionManager.clickSlot(
                            handler.syncId,
                            i,
                            0,
                            SlotActionType.QUICK_MOVE,
                            this.player
                        );
                    }
                }
            }
            
            private void returnAllItems(ScreenHandler handler, MinecraftClient client) {
                // Return all items from player inventory to container
                int containerSlots = handler.slots.size() - 36;
                int totalSlots = handler.slots.size();
                
                for (int i = containerSlots; i < totalSlots; i++) {
                    Slot slot = handler.slots.get(i);
                    if (slot.hasStack()) {
                        // Quick move back to container
                        client.interactionManager.clickSlot(
                            handler.syncId,
                            i,
                            0,
                            SlotActionType.QUICK_MOVE,
                            this.player
                        );
                    }
                }
            }
        }
        EOF

    - name: Write fabric.mod.json
      run: |
        cat > src/main/resources/fabric.mod.json << 'EOF'
        {
          "schemaVersion": 1,
          "id": "quicktransfer",
          "version": "1.0.0",
          "name": "Quick Transfer",
          "description": "Key 7: Take all | Key 8: Return all | Key 9: Auto loop for testing!",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.quicktransfer.QuickTransferMod"]
          },
          "mixins": ["quicktransfer.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.19",
            "minecraft": "1.20.1"
          }
        }
        EOF

    - name: Write quicktransfer.mixins.json
      run: |
        cat > src/main/resources/quicktransfer.mixins.json << 'EOF'
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.quicktransfer.mixin",
          "compatibilityLevel": "JAVA_17",
          "client": [
            "MinecraftClientMixin"
          ],
          "injectors": {"defaultRequire": 1}
        }
        EOF

    - name: Write build.gradle
      run: |
        cat > build.gradle << 'EOF'
        plugins {
            id 'fabric-loom' version '1.6-SNAPSHOT'
            id 'maven-publish'
        }
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        archivesBaseName = "quick-transfer"
        version = "1.0.0"
        group = "com.quicktransfer"
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
        }
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "net.fabricmc.fabric-api:fabric-api:0.92.2+1.20.1"
        }
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
            it.options.release = 17
        }
        java { withSourcesJar() }
        EOF

    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties

    - name: Write settings.gradle
      run: |
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                maven { name = 'Fabric'; url = 'https://maven.fabricmc.net/' }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'quick-transfer'
        EOF

    - name: Build
      run: |
        gradle wrapper --gradle-version 8.1
        chmod +x gradlew
        ./gradlew clean build --no-daemon --stacktrace

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: quick-transfer-v1.0.0-mc1.20.1
        path: build/libs/*.jar
