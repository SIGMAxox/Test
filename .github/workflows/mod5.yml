name: Build Reach PVP Mod
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    - uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    - name: Clean
      run: rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew*
    - name: Create dirs
      run: mkdir -p src/main/java/com/reachpvp/mixin src/main/resources
    - name: Write Java files
      run: |
        cat > src/main/java/com/reachpvp/ReachPVPMod.java << 'EOF'
        package com.reachpvp;
        import net.fabricmc.api.ClientModInitializer;
        public class ReachPVPMod implements ClientModInitializer {
            public static boolean isEnabled = false;
            public static final float REACH = 3.5f;
            @Override
            public void onInitializeClient() {
                System.out.println("[Reach PVP] Loaded! Press 9 to toggle.");
            }
        }
        EOF

        cat > src/main/java/com/reachpvp/mixin/MinecraftClientMixin.java << 'EOF'
        package com.reachpvp.mixin;
        import com.reachpvp.ReachPVPMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.client.network.ClientPlayerInteractionManager;
        import net.minecraft.entity.Entity;
        import net.minecraft.entity.player.PlayerEntity;
        import net.minecraft.text.Text;
        import net.minecraft.util.Hand;
        import net.minecraft.util.hit.EntityHitResult;
        import net.minecraft.util.hit.HitResult;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        @Mixin(MinecraftClient.class)
        public abstract class MinecraftClientMixin {
            @Shadow public ClientPlayerEntity player;
            @Shadow public ClientPlayerInteractionManager interactionManager;
            @Shadow public HitResult crosshairTarget;
            private boolean wasKeyPressed = false;
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                MinecraftClient client = (MinecraftClient)(Object)this;
                boolean isKeyPressed = GLFW.glfwGetKey(client.getWindow().getHandle(), GLFW.GLFW_KEY_9) == GLFW.GLFW_PRESS;
                if (isKeyPressed && !wasKeyPressed) {
                    ReachPVPMod.isEnabled = !ReachPVPMod.isEnabled;
                    String status = ReachPVPMod.isEnabled ? "\u00a7aON (Reach 3.5)" : "\u00a7cOFF";
                    this.player.sendMessage(Text.literal("\u00a76[Reach PVP] " + status), true);
                }
                wasKeyPressed = isKeyPressed;
                if (!ReachPVPMod.isEnabled) return;
                if (this.interactionManager == null) return;
                boolean isLeftClickHeld = GLFW.glfwGetMouseButton(client.getWindow().getHandle(), GLFW.GLFW_MOUSE_BUTTON_LEFT) == GLFW.GLFW_PRESS;
                if (!isLeftClickHeld) return;
                if (this.crosshairTarget == null) return;
                if (this.crosshairTarget.getType() != HitResult.Type.ENTITY) return;
                Entity target = ((EntityHitResult) this.crosshairTarget).getEntity();
                if (!(target instanceof PlayerEntity)) return;
                if (this.player.distanceTo(target) <= ReachPVPMod.REACH) {
                    this.interactionManager.attackEntity(this.player, target);
                    this.player.swingHand(Hand.MAIN_HAND);
                }
            }
        }
        EOF

        cat > src/main/java/com/reachpvp/mixin/InteractionManagerMixin.java << 'EOF'
        package com.reachpvp.mixin;
        import com.reachpvp.ReachPVPMod;
        import net.minecraft.client.network.ClientPlayerInteractionManager;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;
        @Mixin(ClientPlayerInteractionManager.class)
        public class InteractionManagerMixin {
            @Inject(method = "getReachDistance", at = @At("HEAD"), cancellable = true)
            private void onGetReachDistance(CallbackInfoReturnable<Float> cir) {
                if (ReachPVPMod.isEnabled) cir.setReturnValue(ReachPVPMod.REACH);
            }
        }
        EOF

        cat > src/main/java/com/reachpvp/mixin/GameRendererMixin.java << 'EOF'
        package com.reachpvp.mixin;
        import com.reachpvp.ReachPVPMod;
        import net.minecraft.client.render.GameRenderer;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.ModifyVariable;
        @Mixin(GameRenderer.class)
        public class GameRendererMixin {
            @ModifyVariable(
                method = "updateTargetedEntity",
                at = @At(value = "INVOKE_ASSIGN", target = "Lnet/minecraft/client/network/ClientPlayerInteractionManager;getReachDistance()F"),
                index = 1
            )
            private float modifyReachDistance(float original) {
                return ReachPVPMod.isEnabled ? ReachPVPMod.REACH : original;
            }
        }
        EOF

    - name: Write resource files
      run: |
        cat > src/main/resources/fabric.mod.json << 'EOF'
        {"schemaVersion":1,"id":"reachpvp","version":"1.0.0","name":"Reach PVP","description":"Press 9 to toggle!","authors":["SIGMAxox"],"license":"MIT","environment":"client","entrypoints":{"client":["com.reachpvp.ReachPVPMod"]},"mixins":["reachpvp.mixins.json"],"depends":{"fabricloader":">=0.14.19","minecraft":"1.20.1"}}
        EOF
        cat > src/main/resources/reachpvp.mixins.json << 'EOF'
        {"required":true,"minVersion":"0.8","package":"com.reachpvp.mixin","compatibilityLevel":"JAVA_17","client":["MinecraftClientMixin","InteractionManagerMixin","GameRendererMixin"],"injectors":{"defaultRequire":1}}
        EOF

    - name: Write build files
      run: |
        cat > build.gradle << 'EOF'
        plugins { id 'fabric-loom' version '1.2-SNAPSHOT'; id 'maven-publish' }
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        archivesBaseName = "reach-pvp"
        version = "1.0.0"
        group = "com.reachpvp"
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven { url 'https://www.cursemaven.com'; content { includeGroup "curse.maven" } }
        }
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "curse.maven:fabric-api-306612:4902738"
        }
        processResources { inputs.property "version", project.version; filesMatching("fabric.mod.json") { expand "version": project.version } }
        tasks.withType(JavaCompile).configureEach { it.options.encoding = "UTF-8"; it.options.release = 17 }
        java { withSourcesJar() }
        EOF
        echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
        cat > settings.gradle << 'EOF'
        pluginManagement { repositories { maven { name = 'Fabric'; url = 'https://maven.fabricmc.net/' }; gradlePluginPortal() } }
        rootProject.name = 'reach-pvp'
        EOF

    - name: Build
      run: |
        gradle wrapper --gradle-version 8.1
        chmod +x gradlew
        ./gradlew clean build --no-daemon --stacktrace

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: reach-pvp-v1.0.0-mc1.20.1
        path: build/libs/*.jar
