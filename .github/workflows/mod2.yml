name: Build MAXIMUM POWER Dupe Mod (1.20.1 - No Limits)

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    
    - name: Clean everything
      run: |
        rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew* .gitignore
        find . -name "*.java" -delete
        find . -name "*.json" -delete
    
    - name: Create directories
      run: |
        mkdir -p src/main/java/com/maxdupe/mixin
        mkdir -p src/main/resources
    
    - name: Write MaxDupeMod.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/maxdupe/MaxDupeMod.java
        package com.maxdupe;
        
        import net.fabricmc.api.ClientModInitializer;
        import it.unimi.dsi.fastutil.ints.Int2ObjectMap;
        import it.unimi.dsi.fastutil.ints.Int2ObjectArrayMap;
        import net.minecraft.item.ItemStack;
        import net.minecraft.network.packet.Packet;
        import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
        import net.minecraft.network.packet.c2s.play.ButtonClickC2SPacket;
        import net.minecraft.network.packet.c2s.play.CloseHandledScreenC2SPacket;
        import java.util.ArrayList;
        import java.util.List;
        
        public class MaxDupeMod implements ClientModInitializer {
            public static final String MOD_ID = "maxdupe";
            
            // Packet delay system (wakDuper style)
            public static boolean delayPackets = false;
            public static boolean closeWithoutPacket = false;
            public static final List<Packet<?>> storedPackets = new ArrayList<>();
            
            @Override
            public void onInitializeClient() {
                System.out.println("=============================================");
                System.out.println("[MAX DUPE] MAXIMUM POWER MODE ACTIVATED");
                System.out.println("[MAX DUPE] Based on wakDuper + Wurst techniques");
                System.out.println("[MAX DUPE] RIGHT ALT = Dupe Item in Hand");
                System.out.println("[MAX DUPE] LEFT ALT = Toggle Delay Packets");
                System.out.println("[MAX DUPE] F = Close Without Packet");
                System.out.println("=============================================");
            }
        }
        EOF
    
    - name: Write MinecraftClientMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/maxdupe/mixin/MinecraftClientMixin.java
        package com.maxdupe.mixin;
        
        import com.maxdupe.MaxDupeMod;
        import it.unimi.dsi.fastutil.ints.Int2ObjectArrayMap;
        import it.unimi.dsi.fastutil.ints.Int2ObjectMap;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.item.ItemStack;
        import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
        import net.minecraft.screen.slot.SlotActionType;
        import net.minecraft.text.Text;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        @Mixin(MinecraftClient.class)
        public class MinecraftClientMixin {
            @Shadow
            public ClientPlayerEntity player;
            
            private boolean wasRightAltPressed = false;
            private boolean wasLeftAltPressed = false;
            private boolean wasFPressed = false;
            private int cooldown = 0;
            
            /**
             * MAX DUPE MOD - MAXIMUM POWER
             * 
             * Based on wakDuper and Wurst Client techniques
             * 
             * Controls:
             * RIGHT ALT = Instant dupe (spam packets)
             * LEFT ALT = Toggle packet delay
             * F = Close without packet
             */
            @Inject(method = "tick", at = @At("HEAD"))
            private void onClientTick(CallbackInfo ci) {
                if (this.player == null) return;
                if (cooldown > 0) {
                    cooldown--;
                    return;
                }
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                
                // RIGHT ALT - INSTANT DUPE
                boolean isRightAltPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_RIGHT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isRightAltPressed && !wasRightAltPressed) {
                    instantDupe();
                    cooldown = 10;
                }
                wasRightAltPressed = isRightAltPressed;
                
                // LEFT ALT - TOGGLE DELAY PACKETS
                boolean isLeftAltPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_LEFT_ALT
                ) == GLFW.GLFW_PRESS;
                
                if (isLeftAltPressed && !wasLeftAltPressed) {
                    MaxDupeMod.delayPackets = !MaxDupeMod.delayPackets;
                    
                    if (!MaxDupeMod.delayPackets && !MaxDupeMod.storedPackets.isEmpty()) {
                        // Send all stored packets
                        for (var packet : MaxDupeMod.storedPackets) {
                            client.getNetworkHandler().sendPacket(packet);
                        }
                        this.player.sendMessage(
                            Text.literal("§a[MAX] Sent " + MaxDupeMod.storedPackets.size() + " packets!"), 
                            true
                        );
                        MaxDupeMod.storedPackets.clear();
                    }
                    
                    String status = MaxDupeMod.delayPackets ? "§a§lON" : "§c§lOFF";
                    this.player.sendMessage(
                        Text.literal("§6[MAX] Delay Packets: " + status), 
                        true
                    );
                }
                wasLeftAltPressed = isLeftAltPressed;
                
                // F - CLOSE WITHOUT PACKET
                boolean isFPressed = GLFW.glfwGetKey(
                    client.getWindow().getHandle(), 
                    GLFW.GLFW_KEY_F
                ) == GLFW.GLFW_PRESS;
                
                if (isFPressed && !wasFPressed) {
                    MaxDupeMod.closeWithoutPacket = !MaxDupeMod.closeWithoutPacket;
                    String status = MaxDupeMod.closeWithoutPacket ? "§a§lON" : "§c§lOFF";
                    this.player.sendMessage(
                        Text.literal("§6[MAX] Close Without Packet: " + status), 
                        true
                    );
                }
                wasFPressed = isFPressed;
            }
            
            /**
             * INSTANT DUPE - MAXIMUM POWER
             * Spams packets at maximum speed
             */
            private void instantDupe() {
                if (this.player == null) return;
                
                MinecraftClient client = (MinecraftClient)(Object)this;
                ItemStack heldItem = this.player.getMainHandStack();
                
                if (heldItem.isEmpty()) {
                    this.player.sendMessage(
                        Text.literal("§c[MAX] Hold an item!"), 
                        true
                    );
                    return;
                }
                
                this.player.sendMessage(
                    Text.literal("§6[MAX] DUPING: " + heldItem.getName().getString()), 
                    true
                );
                
                int slot = this.player.getInventory().selectedSlot;
                
                // METHOD 1: Drop spam (50 drops)
                for (int i = 0; i < 50; i++) {
                    this.player.dropSelectedItem(false);
                }
                
                // METHOD 2: Packet spam (100 packets)
                for (int i = 0; i < 100; i++) {
                    Int2ObjectMap<ItemStack> changes = new Int2ObjectArrayMap<>();
                    
                    ClickSlotC2SPacket packet = new ClickSlotC2SPacket(
                        0,
                        0,
                        slot,
                        0,
                        SlotActionType.PICKUP,
                        heldItem.copy(),
                        changes
                    );
                    
                    client.getNetworkHandler().sendPacket(packet);
                }
                
                // METHOD 3: Throw spam (30 throws)
                for (int i = 0; i < 30; i++) {
                    this.player.dropSelectedItem(true); // Drop stack
                }
                
                System.out.println("[MAX DUPE] Sent 180 exploit packets!");
                
                this.player.sendMessage(
                    Text.literal("§a[MAX] 180 PACKETS SENT! Check inventory!"), 
                    true
                );
            }
        }
        EOF
    
    - name: Write ClientPlayNetworkHandlerMixin.java
      shell: bash
      run: |
        cat << 'EOF' > src/main/java/com/maxdupe/mixin/ClientPlayNetworkHandlerMixin.java
        package com.maxdupe.mixin;
        
        import com.maxdupe.MaxDupeMod;
        import net.minecraft.client.network.ClientPlayNetworkHandler;
        import net.minecraft.network.packet.Packet;
        import net.minecraft.network.packet.c2s.play.ButtonClickC2SPacket;
        import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
        import net.minecraft.network.packet.c2s.play.CloseHandledScreenC2SPacket;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        
        @Mixin(ClientPlayNetworkHandler.class)
        public class ClientPlayNetworkHandlerMixin {
            
            /**
             * Packet interception for delay and close without packet
             */
            @Inject(method = "sendPacket(Lnet/minecraft/network/packet/Packet;)V", at = @At("HEAD"), cancellable = true)
            private void onSendPacket(Packet<?> packet, CallbackInfo ci) {
                
                // Close without packet
                if (MaxDupeMod.closeWithoutPacket && packet instanceof CloseHandledScreenC2SPacket) {
                    System.out.println("[MAX DUPE] Blocked CloseHandledScreenC2SPacket!");
                    ci.cancel();
                    return;
                }
                
                // Delay packets
                if (MaxDupeMod.delayPackets) {
                    if (packet instanceof ClickSlotC2SPacket || packet instanceof ButtonClickC2SPacket) {
                        MaxDupeMod.storedPackets.add(packet);
                        System.out.println("[MAX DUPE] Stored packet! Total: " + MaxDupeMod.storedPackets.size());
                        ci.cancel();
                        return;
                    }
                }
            }
        }
        EOF
    
    - name: Write fabric.mod.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/fabric.mod.json
        {
          "schemaVersion": 1,
          "id": "maxdupe",
          "version": "1.0.0",
          "name": "MAX DUPE",
          "description": "MAXIMUM POWER! Based on wakDuper + Wurst. RIGHT ALT = Instant Dupe (180 packets), LEFT ALT = Delay Packets, F = Close Without Packet. NO LIMITS!",
          "authors": ["MAX"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.maxdupe.MaxDupeMod"]
          },
          "mixins": ["maxdupe.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.19",
            "minecraft": "1.20.1"
          }
        }
        EOF
    
    - name: Write maxdupe.mixins.json
      shell: bash
      run: |
        cat << 'EOF' > src/main/resources/maxdupe.mixins.json
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.maxdupe.mixin",
          "compatibilityLevel": "JAVA_17",
          "client": [
            "MinecraftClientMixin",
            "ClientPlayNetworkHandlerMixin"
          ],
          "injectors": {"defaultRequire": 1}
        }
        EOF
    
    - name: Write build.gradle
      shell: bash
      run: |
        cat << 'EOF' > build.gradle
        plugins {
            id 'fabric-loom' version '1.2-SNAPSHOT'
            id 'maven-publish'
        }
        
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        
        archivesBaseName = "max-dupe"
        version = "1.0.0"
        group = "com.maxdupe"
        
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "curse.maven:fabric-api-306612:4902738"
        }
        
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
            it.options.release = 17
        }
        
        java {
            withSourcesJar()
        }
        
        jar {
            from("LICENSE") {
                rename { "${it}_${project.archivesBaseName}"}
            }
        }
        EOF
    
    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties
    
    - name: Write settings.gradle
      shell: bash
      run: |
        cat << 'EOF' > settings.gradle
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'max-dupe'
        EOF
    
    - name: Create Gradle Wrapper
      run: gradle wrapper --gradle-version 8.1
    
    - name: Grant execute permission
      run: chmod +x gradlew
    
    - name: Verify all files
      run: |
        echo "=== Source files ==="
        find src -type f -exec echo {} \; -exec cat {} \;
        echo ""
        echo "=== Config files ==="
        cat build.gradle
        echo ""
        cat settings.gradle
    
    - name: Build mod
      run: ./gradlew clean build --no-daemon --stacktrace
    
    - name: List build output
      run: ls -lah build/libs/
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: max-dupe-v1.0.0-NO-LIMITS-mc1.20.1
        path: build/libs/*.jar
