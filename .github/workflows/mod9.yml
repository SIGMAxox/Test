name: Build Fast Chest Loot Mod (1.20.1)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    - uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.1
    - name: Clean
      run: rm -rf src/ build/ .gradle/ gradle/ *.gradle *.properties gradlew*
    - name: Create dirs
      run: mkdir -p src/main/java/com/fastloot/mixin src/main/resources

    - name: Write FastLootMod.java
      run: |
        cat > src/main/java/com/fastloot/FastLootMod.java << 'EOF'
        package com.fastloot;
        import net.fabricmc.api.ClientModInitializer;
        public class FastLootMod implements ClientModInitializer {
            @Override
            public void onInitializeClient() {
                System.out.println("[SMART GLITCH] Loaded!");
                System.out.println("[SMART GLITCH] Hold F8 to spam take/return items!");
                System.out.println("[SMART GLITCH] Speed: 20 cycles/sec (Anti-spam safe!)");
            }
        }
        EOF

    - name: Write HandledScreenMixin.java
      run: |
        cat > src/main/java/com/fastloot/mixin/HandledScreenMixin.java << 'EOF'
        package com.fastloot.mixin;
        import net.minecraft.client.gui.screen.ingame.HandledScreen;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.screen.ScreenHandler;
        import net.minecraft.screen.slot.Slot;
        import net.minecraft.screen.slot.SlotActionType;
        import net.minecraft.text.Text;
        import org.lwjgl.glfw.GLFW;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.Shadow;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
        import java.util.ArrayList;
        import java.util.List;
        @Mixin(HandledScreen.class)
        public abstract class HandledScreenMixin {
            @Shadow protected ScreenHandler handler;
            @Shadow protected abstract void onMouseClick(Slot slot, int slotId, int button, SlotActionType actionType);
            private boolean isSpamming = false;
            private Thread spamThread = null;
            private int spamCount = 0;
            private static final int DELAY_MS = 50;
            @Inject(method = "tick", at = @At("HEAD"))
            private void onTick(CallbackInfo ci) {
                ClientPlayerEntity player = net.minecraft.client.MinecraftClient.getInstance().player;
                if (player == null) return;
                boolean isF8Pressed = GLFW.glfwGetKey(
                    net.minecraft.client.MinecraftClient.getInstance().getWindow().getHandle(),
                    GLFW.GLFW_KEY_F8
                ) == GLFW.GLFW_PRESS;
                if (isF8Pressed && !isSpamming) {
                    startSpamming(player);
                } else if (!isF8Pressed && isSpamming) {
                    stopSpamming(player);
                }
            }
            private void startSpamming(ClientPlayerEntity player) {
                isSpamming = true;
                spamCount = 0;
                player.sendMessage(
                    Text.literal("\u00a7a\u00a7l[SMART GLITCH] \u00a7eSTARTED! (20/sec - Anti-spam safe)"),
                    true
                );
                spamThread = new Thread(() -> {
                    while (isSpamming) {
                        try {
                            List<Slot> containerSlots = new ArrayList<>();
                            List<Slot> playerSlots = new ArrayList<>();
                            for (Slot slot : this.handler.slots) {
                                if (slot.inventory == player.getInventory()) {
                                    playerSlots.add(slot);
                                } else {
                                    containerSlots.add(slot);
                                }
                            }
                            for (Slot slot : containerSlots) {
                                if (slot.hasStack()) {
                                    this.onMouseClick(slot, slot.id, 0, SlotActionType.QUICK_MOVE);
                                }
                            }
                            Thread.sleep(DELAY_MS / 2);
                            for (Slot slot : playerSlots) {
                                if (slot.hasStack()) {
                                    this.onMouseClick(slot, slot.id, 0, SlotActionType.QUICK_MOVE);
                                }
                            }
                            spamCount++;
                            Thread.sleep(DELAY_MS / 2);
                        } catch (InterruptedException e) {
                            break;
                        }
                    }
                });
                spamThread.start();
            }
            private void stopSpamming(ClientPlayerEntity player) {
                isSpamming = false;
                if (spamThread != null) {
                    spamThread.interrupt();
                    spamThread = null;
                }
                player.sendMessage(
                    Text.literal("\u00a7a\u00a7l[SMART GLITCH] \u00a77STOPPED! Cycled " + spamCount + " times! \u00a7a\u2713"),
                    false
                );
            }
        }
        EOF

    - name: Write fabric.mod.json
      run: |
        cat > src/main/resources/fabric.mod.json << 'EOF'
        {
          "schemaVersion": 1,
          "id": "fastloot",
          "version": "1.0.0",
          "name": "Smart Glitch",
          "description": "Hold F8 to rapidly take/return items at 20 cycles per second. Anti-spam safe! Perfect for duplication glitching.",
          "authors": ["SIGMAxox"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.fastloot.FastLootMod"]
          },
          "mixins": ["fastloot.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.19",
            "minecraft": "1.20.1"
          }
        }
        EOF

    - name: Write fastloot.mixins.json
      run: |
        cat > src/main/resources/fastloot.mixins.json << 'EOF'
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.fastloot.mixin",
          "compatibilityLevel": "JAVA_17",
          "client": [
            "HandledScreenMixin"
          ],
          "injectors": {"defaultRequire": 1}
        }
        EOF

    - name: Write build.gradle
      run: |
        cat > build.gradle << 'EOF'
        plugins {
            id 'fabric-loom' version '1.2-SNAPSHOT'
            id 'maven-publish'
        }
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
        archivesBaseName = "fast-loot"
        version = "1.0.0"
        group = "com.fastloot"
        repositories {
            maven { url 'https://maven.fabricmc.net/' }
            maven {
                url 'https://www.cursemaven.com'
                content { includeGroup "curse.maven" }
            }
        }
        dependencies {
            minecraft "com.mojang:minecraft:1.20.1"
            mappings "net.fabricmc:yarn:1.20.1+build.10:v2"
            modImplementation "net.fabricmc:fabric-loader:0.14.19"
            modImplementation "curse.maven:fabric-api-306612:4902738"
        }
        processResources {
            inputs.property "version", project.version
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }
        tasks.withType(JavaCompile).configureEach {
            it.options.encoding = "UTF-8"
            it.options.release = 17
        }
        java { withSourcesJar() }
        EOF

    - name: Write gradle.properties
      run: echo 'org.gradle.jvmargs=-Xmx2G' > gradle.properties

    - name: Write settings.gradle
      run: |
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                maven { name = 'Fabric'; url = 'https://maven.fabricmc.net/' }
                gradlePluginPortal()
            }
        }
        rootProject.name = 'fast-loot'
        EOF

    - name: Build
      run: |
        gradle wrapper --gradle-version 8.1
        chmod +x gradlew
        ./gradlew clean build --no-daemon --stacktrace

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: fast-loot-v1.0.0-mc1.20.1
        path: build/libs/*.jar
